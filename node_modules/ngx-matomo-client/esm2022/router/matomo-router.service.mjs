import { isPlatformBrowser } from '@angular/common';
import { Inject, Injectable, Optional, PLATFORM_ID } from '@angular/core';
import { NavigationEnd } from '@angular/router';
import { ɵrunOnce as runOnce } from 'ngx-matomo-client/core';
import { combineLatest, forkJoin, from, identity, of, } from 'rxjs';
import { concatMap, defaultIfEmpty, delay, distinctUntilChanged, filter, map, mapTo, switchMap, take, tap, } from 'rxjs/operators';
import { INTERNAL_ROUTER_CONFIGURATION, } from './configuration';
import { invalidInterceptorsProviderError, ROUTER_ALREADY_INITIALIZED_ERROR } from './errors';
import { MATOMO_ROUTER_INTERCEPTORS } from './interceptor';
import { MATOMO_PAGE_TITLE_PROVIDER } from './page-title-providers';
import { MATOMO_PAGE_URL_PROVIDER } from './page-url-provider';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "ngx-matomo-client/core";
function isNavigationEnd(event) {
    return event instanceof NavigationEnd;
}
function coerceRegExp(input) {
    return typeof input === 'string' ? new RegExp(input) : input;
}
function coerceRegExpArray(input) {
    if (!input) {
        return [];
    }
    return Array.isArray(input) ? input.map(coerceRegExp) : [coerceRegExp(input)];
}
function isNotExcluded(excludeConfig) {
    const exclusions = coerceRegExpArray(excludeConfig);
    return (event) => !exclusions.some(rx => event.urlAfterRedirects.match(rx));
}
function stripQueryParams(url) {
    return url.split('?')[0];
}
function defaultNavigationEndComparator(urlExtractor) {
    return (eventA, eventB) => urlExtractor(eventA) === urlExtractor(eventB);
}
function getNavigationEndComparator(config) {
    switch (config.navigationEndComparator) {
        case 'fullUrl':
            return defaultNavigationEndComparator(event => event.urlAfterRedirects);
        case 'ignoreQueryParams':
            return defaultNavigationEndComparator(event => stripQueryParams(event.urlAfterRedirects));
        default:
            return config.navigationEndComparator;
    }
}
export class MatomoRouter {
    constructor(router, platformId, config, pageTitleProvider, pageUrlProvider, tracker, interceptors) {
        this.router = router;
        this.platformId = platformId;
        this.config = config;
        this.pageTitleProvider = pageTitleProvider;
        this.pageUrlProvider = pageUrlProvider;
        this.tracker = tracker;
        this.interceptors = interceptors;
        this.initialize = runOnce(() => {
            if (this.config.disabled || !isPlatformBrowser(this.platformId)) {
                // Do not set-up router if globally disabled or running on server
                return;
            }
            const delayOp = this.config.delay === -1 ? identity : delay(this.config.delay);
            const navigationEndComparator = getNavigationEndComparator(this.config);
            this.router.events
                .pipe(
            // Take only NavigationEnd events
            filter(isNavigationEnd), 
            // Filter out excluded urls
            filter(isNotExcluded(this.config.exclude)), 
            // Filter out NavigationEnd events to ignore, e.g. when url does not actually change (component reload)
            distinctUntilChanged(navigationEndComparator), 
            // Optionally add some delay
            delayOp, 
            // Set default page title & url
            switchMap(event => this.presetPageTitleAndUrl(event).pipe(map(({ pageUrl }) => ({ pageUrl, event })))), 
            // Run interceptors then track page view
            concatMap(({ event, pageUrl }) => this.callInterceptors(event).pipe(tap(() => this.trackPageView(pageUrl)))))
                .subscribe();
        }, ROUTER_ALREADY_INITIALIZED_ERROR);
        if (interceptors && !Array.isArray(interceptors)) {
            throw invalidInterceptorsProviderError();
        }
    }
    /** @deprecated use {@link initialize initialize()} instead */
    init() {
        this.initialize();
    }
    callInterceptors(event) {
        if (this.interceptors) {
            return forkJoin(this.interceptors.map(interceptor => {
                const result = interceptor.beforePageTrack(event);
                const result$ = result == null ? of(undefined) : from(result);
                // Must not be an empty observable (otherwise forkJoin would complete without waiting others)
                return result$.pipe(take(1), defaultIfEmpty(undefined));
            })).pipe(mapTo(undefined), defaultIfEmpty(undefined));
        }
        else {
            return of(undefined);
        }
    }
    presetPageTitleAndUrl(event) {
        const title$ = this.config.trackPageTitle
            ? this.pageTitleProvider
                .getCurrentPageTitle(event)
                .pipe(tap(pageTitle => this.tracker.setDocumentTitle(pageTitle)))
            : of(undefined);
        const url$ = this.pageUrlProvider
            .getCurrentPageUrl(event)
            .pipe(tap(pageUrl => this.tracker.setCustomUrl(pageUrl)));
        return combineLatest([title$, url$]).pipe(map(([_, pageUrl]) => ({ pageUrl })));
    }
    trackPageView(pageUrl) {
        this.tracker.trackPageView();
        if (this.config.enableLinkTracking) {
            this.tracker.enableLinkTracking(this.config.enableLinkTracking === 'enable-pseudo');
        }
        // Set referrer for next page view
        this.tracker.setReferrerUrl(pageUrl);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.2", ngImport: i0, type: MatomoRouter, deps: [{ token: i1.Router }, { token: PLATFORM_ID }, { token: INTERNAL_ROUTER_CONFIGURATION }, { token: MATOMO_PAGE_TITLE_PROVIDER }, { token: MATOMO_PAGE_URL_PROVIDER }, { token: i2.MatomoTracker }, { token: MATOMO_ROUTER_INTERCEPTORS, optional: true }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.3.2", ngImport: i0, type: MatomoRouter, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.2", ngImport: i0, type: MatomoRouter, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: () => [{ type: i1.Router }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [PLATFORM_ID]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [INTERNAL_ROUTER_CONFIGURATION]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [MATOMO_PAGE_TITLE_PROVIDER]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [MATOMO_PAGE_URL_PROVIDER]
                }] }, { type: i2.MatomoTracker }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [MATOMO_ROUTER_INTERCEPTORS]
                }] }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0b21vLXJvdXRlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LW1hdG9tby1jbGllbnQvcm91dGVyL21hdG9tby1yb3V0ZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFFLE9BQU8sRUFBUyxhQUFhLEVBQVUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvRCxPQUFPLEVBQWlCLFFBQVEsSUFBSSxPQUFPLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM1RSxPQUFPLEVBQ0wsYUFBYSxFQUNiLFFBQVEsRUFDUixJQUFJLEVBQ0osUUFBUSxFQUdSLEVBQUUsR0FDSCxNQUFNLE1BQU0sQ0FBQztBQUNkLE9BQU8sRUFDTCxTQUFTLEVBQ1QsY0FBYyxFQUNkLEtBQUssRUFDTCxvQkFBb0IsRUFDcEIsTUFBTSxFQUNOLEdBQUcsRUFDSCxLQUFLLEVBQ0wsU0FBUyxFQUNULElBQUksRUFDSixHQUFHLEdBQ0osTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QixPQUFPLEVBRUwsNkJBQTZCLEdBRzlCLE1BQU0saUJBQWlCLENBQUM7QUFDekIsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQzlGLE9BQU8sRUFBRSwwQkFBMEIsRUFBMkIsTUFBTSxlQUFlLENBQUM7QUFDcEYsT0FBTyxFQUFFLDBCQUEwQixFQUFxQixNQUFNLHdCQUF3QixDQUFDO0FBQ3ZGLE9BQU8sRUFBRSx3QkFBd0IsRUFBbUIsTUFBTSxxQkFBcUIsQ0FBQzs7OztBQUVoRixTQUFTLGVBQWUsQ0FBQyxLQUFZO0lBQ25DLE9BQU8sS0FBSyxZQUFZLGFBQWEsQ0FBQztBQUN4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QUFPLGFBQWEsQ0FBQyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2xGLENBQUM7SUFFTyxhQUFhLENBQUMsT0FBZTtRQUNuQyxJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRTdCLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRTtZQUNsQyxJQUFJLENBQUMsT0FBTyxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsa0JBQWtCLEtBQUssZUFBZSxDQUFDLENBQUM7U0FDckY7UUFFRCxrQ0FBa0M7UUFDbEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDdkMsQ0FBQzs4R0FoR1UsWUFBWSx3Q0FHYixXQUFXLGFBRVgsNkJBQTZCLGFBRTdCLDBCQUEwQixhQUUxQix3QkFBd0IsMENBSXhCLDBCQUEwQjtrSEFiekIsWUFBWSxjQURDLE1BQU07OzJGQUNuQixZQUFZO2tCQUR4QixVQUFVO21CQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRTs7MEJBSTdCLE1BQU07MkJBQUMsV0FBVzs7MEJBRWxCLE1BQU07MkJBQUMsNkJBQTZCOzswQkFFcEMsTUFBTTsyQkFBQywwQkFBMEI7OzBCQUVqQyxNQUFNOzJCQUFDLHdCQUF3Qjs7MEJBRy9CLFFBQVE7OzBCQUNSLE1BQU07MkJBQUMsMEJBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBPcHRpb25hbCwgUExBVEZPUk1fSUQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEV2ZW50LCBOYXZpZ2F0aW9uRW5kLCBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgTWF0b21vVHJhY2tlciwgybVydW5PbmNlIGFzIHJ1bk9uY2UgfSBmcm9tICduZ3gtbWF0b21vLWNsaWVudC9jb3JlJztcbmltcG9ydCB7XG4gIGNvbWJpbmVMYXRlc3QsXG4gIGZvcmtKb2luLFxuICBmcm9tLFxuICBpZGVudGl0eSxcbiAgTW9ub1R5cGVPcGVyYXRvckZ1bmN0aW9uLFxuICBPYnNlcnZhYmxlLFxuICBvZixcbn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICBjb25jYXRNYXAsXG4gIGRlZmF1bHRJZkVtcHR5LFxuICBkZWxheSxcbiAgZGlzdGluY3RVbnRpbENoYW5nZWQsXG4gIGZpbHRlcixcbiAgbWFwLFxuICBtYXBUbyxcbiAgc3dpdGNoTWFwLFxuICB0YWtlLFxuICB0YXAsXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7XG4gIEV4Y2x1c2lvbkNvbmZpZyxcbiAgSU5URVJOQUxfUk9VVEVSX0NPTkZJR1VSQVRJT04sXG4gIEludGVybmFsUm91dGVyQ29uZmlndXJhdGlvbixcbiAgTmF2aWdhdGlvbkVuZENvbXBhcmF0b3IsXG59IGZyb20gJy4vY29uZmlndXJhdGlvbic7XG5pbXBvcnQgeyBpbnZhbGlkSW50ZXJjZXB0b3JzUHJvdmlkZXJFcnJvciwgUk9VVEVSX0FMUkVBRFlfSU5JVElBTElaRURfRVJST1IgfSBmcm9tICcuL2Vycm9ycyc7XG5pbXBvcnQgeyBNQVRPTU9fUk9VVEVSX0lOVEVSQ0VQVE9SUywgTWF0b21vUm91dGVySW50ZXJjZXB0b3IgfSBmcm9tICcuL2ludGVyY2VwdG9yJztcbmltcG9ydCB7IE1BVE9NT19QQUdFX1RJVExFX1BST1ZJREVSLCBQYWdlVGl0bGVQcm92aWRlciB9IGZyb20gJy4vcGFnZS10aXRsZS1wcm92aWRlcnMnO1xuaW1wb3J0IHsgTUFUT01PX1BBR0VfVVJMX1BST1ZJREVSLCBQYWdlVXJsUHJvdmlkZXIgfSBmcm9tICcuL3BhZ2UtdXJsLXByb3ZpZGVyJztcblxuZnVuY3Rpb24gaXNOYXZpZ2F0aW9uRW5kKGV2ZW50OiBFdmVudCk6IGV2ZW50IGlzIE5hdmlnYXRpb25FbmQge1xuICByZXR1cm4gZXZlbnQgaW5zdGFuY2VvZiBOYXZpZ2F0aW9uRW5kO1xufVxuXG5mdW5jdGlvbiBjb2VyY2VSZWdFeHAoaW5wdXQ6IHN0cmluZyB8IFJlZ0V4cCk6IFJlZ0V4cCB7XG4gIHJldHVybiB0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnID8gbmV3IFJlZ0V4cChpbnB1dCkgOiBpbnB1dDtcbn1cblxuZnVuY3Rpb24gY29lcmNlUmVnRXhwQXJyYXkoaW5wdXQ6IEV4Y2x1c2lvbkNvbmZpZyB8IG51bGwgfCB1bmRlZmluZWQpOiBSZWdFeHBbXSB7XG4gIGlmICghaW5wdXQpIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICByZXR1cm4gQXJyYXkuaXNBcnJheShpbnB1dCkgPyBpbnB1dC5tYXAoY29lcmNlUmVnRXhwKSA6IFtjb2VyY2VSZWdFeHAoaW5wdXQpXTtcbn1cblxuZnVuY3Rpb24gaXNOb3RFeGNsdWRlZChleGNsdWRlQ29uZmlnOiBFeGNsdXNpb25Db25maWcpOiAoZXZlbnQ6IE5hdmlnYXRpb25FbmQpID0+IGJvb2xlYW4ge1xuICBjb25zdCBleGNsdXNpb25zID0gY29lcmNlUmVnRXhwQXJyYXkoZXhjbHVkZUNvbmZpZyk7XG5cbiAgcmV0dXJuIChldmVudDogTmF2aWdhdGlvbkVuZCkgPT4gIWV4Y2x1c2lvbnMuc29tZShyeCA9PiBldmVudC51cmxBZnRlclJlZGlyZWN0cy5tYXRjaChyeCkpO1xufVxuXG5mdW5jdGlvbiBzdHJpcFF1ZXJ5UGFyYW1zKHVybDogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIHVybC5zcGxpdCgnPycpWzBdO1xufVxuXG5mdW5jdGlvbiBkZWZhdWx0TmF2aWdhdGlvbkVuZENvbXBhcmF0b3IodXJsRXh0cmFjdG9yOiAoZXZlbnQ6IE5hdmlnYXRpb25FbmQpID0+IHN0cmluZykge1xuICByZXR1cm4gKGV2ZW50QTogTmF2aWdhdGlvbkVuZCwgZXZlbnRCOiBOYXZpZ2F0aW9uRW5kKSA9PlxuICAgIHVybEV4dHJhY3RvcihldmVudEEpID09PSB1cmxFeHRyYWN0b3IoZXZlbnRCKTtcbn1cblxuZnVuY3Rpb24gZ2V0TmF2aWdhdGlvbkVuZENvbXBhcmF0b3IoY29uZmlnOiBJbnRlcm5hbFJvdXRlckNvbmZpZ3VyYXRpb24pOiBOYXZpZ2F0aW9uRW5kQ29tcGFyYXRvciB7XG4gIHN3aXRjaCAoY29uZmlnLm5hdmlnYXRpb25FbmRDb21wYXJhdG9yKSB7XG4gICAgY2FzZSAnZnVsbFVybCc6XG4gICAgICByZXR1cm4gZGVmYXVsdE5hdmlnYXRpb25FbmRDb21wYXJhdG9yKGV2ZW50ID0+IGV2ZW50LnVybEFmdGVyUmVkaXJlY3RzKTtcbiAgICBjYXNlICdpZ25vcmVRdWVyeVBhcmFtcyc6XG4gICAgICByZXR1cm4gZGVmYXVsdE5hdmlnYXRpb25FbmRDb21wYXJhdG9yKGV2ZW50ID0+IHN0cmlwUXVlcnlQYXJhbXMoZXZlbnQudXJsQWZ0ZXJSZWRpcmVjdHMpKTtcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIGNvbmZpZy5uYXZpZ2F0aW9uRW5kQ29tcGFyYXRvcjtcbiAgfVxufVxuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIE1hdG9tb1JvdXRlciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcm91dGVyOiBSb3V0ZXIsXG4gICAgQEluamVjdChQTEFURk9STV9JRClcbiAgICBwcml2YXRlIHJlYWRvbmx5IHBsYXRmb3JtSWQ6IG9iamVjdCxcbiAgICBASW5qZWN0KElOVEVSTkFMX1JPVVRFUl9DT05GSUdVUkFUSU9OKVxuICAgIHByaXZhdGUgcmVhZG9ubHkgY29uZmlnOiBJbnRlcm5hbFJvdXRlckNvbmZpZ3VyYXRpb24sXG4gICAgQEluamVjdChNQVRPTU9fUEFHRV9USVRMRV9QUk9WSURFUilcbiAgICBwcml2YXRlIHJlYWRvbmx5IHBhZ2VUaXRsZVByb3ZpZGVyOiBQYWdlVGl0bGVQcm92aWRlcixcbiAgICBASW5qZWN0KE1BVE9NT19QQUdFX1VSTF9QUk9WSURFUilcbiAgICBwcml2YXRlIHJlYWRvbmx5IHBhZ2VVcmxQcm92aWRlcjogUGFnZVVybFByb3ZpZGVyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgdHJhY2tlcjogTWF0b21vVHJhY2tlcixcbiAgICBAT3B0aW9uYWwoKVxuICAgIEBJbmplY3QoTUFUT01PX1JPVVRFUl9JTlRFUkNFUFRPUlMpXG4gICAgcHJpdmF0ZSByZWFkb25seSBpbnRlcmNlcHRvcnM6IE1hdG9tb1JvdXRlckludGVyY2VwdG9yW10gfCBudWxsLFxuICApIHtcbiAgICBpZiAoaW50ZXJjZXB0b3JzICYmICFBcnJheS5pc0FycmF5KGludGVyY2VwdG9ycykpIHtcbiAgICAgIHRocm93IGludmFsaWRJbnRlcmNlcHRvcnNQcm92aWRlckVycm9yKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqIEBkZXByZWNhdGVkIHVzZSB7QGxpbmsgaW5pdGlhbGl6ZSBpbml0aWFsaXplKCl9IGluc3RlYWQgKi9cbiAgaW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLmluaXRpYWxpemUoKTtcbiAgfVxuXG4gIHJlYWRvbmx5IGluaXRpYWxpemUgPSBydW5PbmNlKCgpID0+IHtcbiAgICBpZiAodGhpcy5jb25maWcuZGlzYWJsZWQgfHwgIWlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCkpIHtcbiAgICAgIC8vIERvIG5vdCBzZXQtdXAgcm91dGVyIGlmIGdsb2JhbGx5IGRpc2FibGVkIG9yIHJ1bm5pbmcgb24gc2VydmVyXG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgZGVsYXlPcDogTW9ub1R5cGVPcGVyYXRvckZ1bmN0aW9uPE5hdmlnYXRpb25FbmQ+ID1cbiAgICAgIHRoaXMuY29uZmlnLmRlbGF5ID09PSAtMSA/IGlkZW50aXR5IDogZGVsYXkodGhpcy5jb25maWcuZGVsYXkpO1xuICAgIGNvbnN0IG5hdmlnYXRpb25FbmRDb21wYXJhdG9yID0gZ2V0TmF2aWdhdGlvbkVuZENvbXBhcmF0b3IodGhpcy5jb25maWcpO1xuXG4gICAgdGhpcy5yb3V0ZXIuZXZlbnRzXG4gICAgICAucGlwZShcbiAgICAgICAgLy8gVGFrZSBvbmx5IE5hdmlnYXRpb25FbmQgZXZlbnRzXG4gICAgICAgIGZpbHRlcihpc05hdmlnYXRpb25FbmQpLFxuICAgICAgICAvLyBGaWx0ZXIgb3V0IGV4Y2x1ZGVkIHVybHNcbiAgICAgICAgZmlsdGVyKGlzTm90RXhjbHVkZWQodGhpcy5jb25maWcuZXhjbHVkZSkpLFxuICAgICAgICAvLyBGaWx0ZXIgb3V0IE5hdmlnYXRpb25FbmQgZXZlbnRzIHRvIGlnbm9yZSwgZS5nLiB3aGVuIHVybCBkb2VzIG5vdCBhY3R1YWxseSBjaGFuZ2UgKGNvbXBvbmVudCByZWxvYWQpXG4gICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKG5hdmlnYXRpb25FbmRDb21wYXJhdG9yKSxcbiAgICAgICAgLy8gT3B0aW9uYWxseSBhZGQgc29tZSBkZWxheVxuICAgICAgICBkZWxheU9wLFxuICAgICAgICAvLyBTZXQgZGVmYXVsdCBwYWdlIHRpdGxlICYgdXJsXG4gICAgICAgIHN3aXRjaE1hcChldmVudCA9PlxuICAgICAgICAgIHRoaXMucHJlc2V0UGFnZVRpdGxlQW5kVXJsKGV2ZW50KS5waXBlKG1hcCgoeyBwYWdlVXJsIH0pID0+ICh7IHBhZ2VVcmwsIGV2ZW50IH0pKSksXG4gICAgICAgICksXG4gICAgICAgIC8vIFJ1biBpbnRlcmNlcHRvcnMgdGhlbiB0cmFjayBwYWdlIHZpZXdcbiAgICAgICAgY29uY2F0TWFwKCh7IGV2ZW50LCBwYWdlVXJsIH0pID0+XG4gICAgICAgICAgdGhpcy5jYWxsSW50ZXJjZXB0b3JzKGV2ZW50KS5waXBlKHRhcCgoKSA9PiB0aGlzLnRyYWNrUGFnZVZpZXcocGFnZVVybCkpKSxcbiAgICAgICAgKSxcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKTtcbiAgfSwgUk9VVEVSX0FMUkVBRFlfSU5JVElBTElaRURfRVJST1IpO1xuXG4gIHByaXZhdGUgY2FsbEludGVyY2VwdG9ycyhldmVudDogTmF2aWdhdGlvbkVuZCk6IE9ic2VydmFibGU8dm9pZD4ge1xuICAgIGlmICh0aGlzLmludGVyY2VwdG9ycykge1xuICAgICAgcmV0dXJuIGZvcmtKb2luKFxuICAgICAgICB0aGlzLmludGVyY2VwdG9ycy5tYXAoaW50ZXJjZXB0b3IgPT4ge1xuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGludGVyY2VwdG9yLmJlZm9yZVBhZ2VUcmFjayhldmVudCk7XG4gICAgICAgICAgY29uc3QgcmVzdWx0JCA9IHJlc3VsdCA9PSBudWxsID8gb2YodW5kZWZpbmVkKSA6IGZyb20ocmVzdWx0KTtcblxuICAgICAgICAgIC8vIE11c3Qgbm90IGJlIGFuIGVtcHR5IG9ic2VydmFibGUgKG90aGVyd2lzZSBmb3JrSm9pbiB3b3VsZCBjb21wbGV0ZSB3aXRob3V0IHdhaXRpbmcgb3RoZXJzKVxuICAgICAgICAgIHJldHVybiByZXN1bHQkLnBpcGUodGFrZSgxKSwgZGVmYXVsdElmRW1wdHkodW5kZWZpbmVkIGFzIHZvaWQpKTtcbiAgICAgICAgfSksXG4gICAgICApLnBpcGUobWFwVG8odW5kZWZpbmVkKSwgZGVmYXVsdElmRW1wdHkodW5kZWZpbmVkIGFzIHZvaWQpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG9mKHVuZGVmaW5lZCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBwcmVzZXRQYWdlVGl0bGVBbmRVcmwoZXZlbnQ6IE5hdmlnYXRpb25FbmQpOiBPYnNlcnZhYmxlPHsgcGFnZVVybDogc3RyaW5nIH0+IHtcbiAgICBjb25zdCB0aXRsZSQgPSB0aGlzLmNvbmZpZy50cmFja1BhZ2VUaXRsZVxuICAgICAgPyB0aGlzLnBhZ2VUaXRsZVByb3ZpZGVyXG4gICAgICAgICAgLmdldEN1cnJlbnRQYWdlVGl0bGUoZXZlbnQpXG4gICAgICAgICAgLnBpcGUodGFwKHBhZ2VUaXRsZSA9PiB0aGlzLnRyYWNrZXIuc2V0RG9jdW1lbnRUaXRsZShwYWdlVGl0bGUpKSlcbiAgICAgIDogb2YodW5kZWZpbmVkKTtcbiAgICBjb25zdCB1cmwkID0gdGhpcy5wYWdlVXJsUHJvdmlkZXJcbiAgICAgIC5nZXRDdXJyZW50UGFnZVVybChldmVudClcbiAgICAgIC5waXBlKHRhcChwYWdlVXJsID0+IHRoaXMudHJhY2tlci5zZXRDdXN0b21VcmwocGFnZVVybCkpKTtcblxuICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KFt0aXRsZSQsIHVybCRdKS5waXBlKG1hcCgoW18sIHBhZ2VVcmxdKSA9PiAoeyBwYWdlVXJsIH0pKSk7XG4gIH1cblxuICBwcml2YXRlIHRyYWNrUGFnZVZpZXcocGFnZVVybDogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy50cmFja2VyLnRyYWNrUGFnZVZpZXcoKTtcblxuICAgIGlmICh0aGlzLmNvbmZpZy5lbmFibGVMaW5rVHJhY2tpbmcpIHtcbiAgICAgIHRoaXMudHJhY2tlci5lbmFibGVMaW5rVHJhY2tpbmcodGhpcy5jb25maWcuZW5hYmxlTGlua1RyYWNraW5nID09PSAnZW5hYmxlLXBzZXVkbycpO1xuICAgIH1cblxuICAgIC8vIFNldCByZWZlcnJlciBmb3IgbmV4dCBwYWdlIHZpZXdcbiAgICB0aGlzLnRyYWNrZXIuc2V0UmVmZXJyZXJVcmwocGFnZVVybCk7XG4gIH1cbn1cbiJdfQ==