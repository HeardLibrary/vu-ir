import { isPlatformBrowser } from '@angular/common';
import { inject, Injectable, PLATFORM_ID } from '@angular/core';
import { initializeMatomoHolder } from '../holder';
import { runOnce } from '../utils/function';
import { ScriptInjector } from '../utils/script-injector';
import { appendTrailingSlash } from '../utils/url';
import { DEFERRED_INTERNAL_MATOMO_CONFIGURATION, getTrackersConfiguration, INTERNAL_MATOMO_CONFIGURATION, isAutoConfigurationMode, isEmbeddedTrackerConfiguration, isExplicitTrackerConfiguration, } from './configuration';
import { ALREADY_INITIALIZED_ERROR, ALREADY_INJECTED_ERROR } from './errors';
import { MatomoTracker } from './matomo-tracker.service';
import * as i0 from "@angular/core";
function coerceSiteId(siteId) {
    return `${siteId}`;
}
function buildTrackerUrl(url, suffix) {
    if (suffix == null) {
        return appendTrailingSlash(url) + DEFAULT_TRACKER_SUFFIX;
    }
    return url + suffix;
}
const DEFAULT_TRACKER_SUFFIX = 'matomo.php';
const DEFAULT_SCRIPT_SUFFIX = 'matomo.js';
export function createMatomoInitializer() {
    const disabled = inject(INTERNAL_MATOMO_CONFIGURATION).disabled;
    const isBrowser = isPlatformBrowser(inject(PLATFORM_ID));
    return disabled || !isBrowser ? new NoopMatomoInitializer() : new MatomoInitializerService();
}
export class NoopMatomoInitializer {
    initialize() {
        // No-op
    }
    init() {
        // No-op
    }
    initializeTracker(_) {
        // No-op
    }
}
export class MatomoInitializerService {
    constructor() {
        this.config = inject(INTERNAL_MATOMO_CONFIGURATION);
        this.deferredConfig = inject(DEFERRED_INTERNAL_MATOMO_CONFIGURATION);
        this.tracker = inject(MatomoTracker);
        this.scriptInjector = inject(ScriptInjector);
        this.initialize = runOnce(() => {
            this.runPreInitTasks();
            if (isAutoConfigurationMode(this.config)) {
                this.injectMatomoScript(this.config);
            }
        }, ALREADY_INITIALIZED_ERROR);
        this.injectMatomoScript = runOnce((config) => {
            if (isExplicitTrackerConfiguration(config)) {
                const { scriptUrl: customScriptUrl } = config;
                const [mainTracker, ...additionalTrackers] = getTrackersConfiguration(config);
                const scriptUrl = customScriptUrl ?? appendTrailingSlash(mainTracker.trackerUrl) + DEFAULT_SCRIPT_SUFFIX;
                this.registerMainTracker(mainTracker);
                this.registerAdditionalTrackers(additionalTrackers);
                this.scriptInjector.injectDOMScript(scriptUrl);
            }
            else if (isEmbeddedTrackerConfiguration(config)) {
                const { scriptUrl, trackers: additionalTrackers } = {
                    trackers: [],
                    ...config,
                };
                this.registerAdditionalTrackers(additionalTrackers);
                this.scriptInjector.injectDOMScript(scriptUrl);
            }
            this.deferredConfig.markReady(config);
        }, ALREADY_INJECTED_ERROR);
        initializeMatomoHolder();
    }
    // TODO v7 remove
    /** @deprecated Will be removed in v7+. Use {@link initialize initialize()} instead. */
    init() {
        this.initialize();
    }
    initializeTracker(config) {
        this.injectMatomoScript(config);
    }
    registerMainTracker(mainTracker) {
        const mainTrackerUrl = buildTrackerUrl(mainTracker.trackerUrl, mainTracker.trackerUrlSuffix);
        const mainTrackerSiteId = coerceSiteId(mainTracker.siteId);
        this.tracker.setTrackerUrl(mainTrackerUrl);
        this.tracker.setSiteId(mainTrackerSiteId);
    }
    registerAdditionalTrackers(additionalTrackers) {
        additionalTrackers.forEach(({ trackerUrl, siteId, trackerUrlSuffix }) => {
            const additionalTrackerUrl = buildTrackerUrl(trackerUrl, trackerUrlSuffix);
            const additionalTrackerSiteId = coerceSiteId(siteId);
            this.tracker.addTracker(additionalTrackerUrl, additionalTrackerSiteId);
        });
    }
    runPreInitTasks() {
        if (this.config.acceptDoNotTrack) {
            this.tracker.setDoNotTrack(true);
        }
        if (this.config.requireConsent === 'cookie') {
            this.tracker.requireCookieConsent();
        }
        else if (this.config.requireConsent === 'tracking') {
            this.tracker.requireConsent();
        }
        if (this.config.enableJSErrorTracking) {
            this.tracker.enableJSErrorTracking();
        }
        if (this.config.disableCampaignParameters) {
            this.tracker.disableCampaignParameters();
        }
        if (this.config.trackAppInitialLoad) {
            this.tracker.trackPageView();
        }
        if (this.config.enableLinkTracking) {
            this.tracker.enableLinkTracking(this.config.enableLinkTracking === 'enable-pseudo');
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.2", ngImport: i0, type: MatomoInitializerService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.3.2", ngImport: i0, type: MatomoInitializerService, providedIn: 'root', useFactory: createMatomoInitializer }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.2", ngImport: i0, type: MatomoInitializerService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                    useFactory: createMatomoInitializer,
                }]
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0b21vLWluaXRpYWxpemVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtbWF0b21vLWNsaWVudC9jb3JlL3RyYWNrZXIvbWF0b21vLWluaXRpYWxpemVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDcEQsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2hFLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNuRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDNUMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRTFELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUNuRCxPQUFPLEVBRUwsc0NBQXNDLEVBQ3RDLHdCQUF3QixFQUN4Qiw2QkFBNkIsRUFDN0IsdUJBQXVCLEVBQ3ZCLDhCQUE4QixFQUM5Qiw4QkFBOEIsR0FFL0IsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QixPQUFPLEVBQUUseUJBQXlCLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDN0UsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDOztBQUV6RCxTQUFTLFlBQVksQ0FBQyxNQUF1QjtJQUMzQyxPQUFPLEdBQUcsTUFBTSxFQUFFLENBQUM7QUFDckIsQ0FBQztBQUVELFNBQVMsZUFBZSxDQUFDLEdBQVcsRUFBRSxNQUEwQjtJQUM5RCxJQUFJLE1BQU0sSUFBSSxJQUFJLEVBQUU7UUFDbEIsT0FBTyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsR0FBRyxzQkFBc0IsQ0FBQztLQUMxRDtJQUNELE9BQU8sR0FBRyxHQUFHLE1BQU0sQ0FBQztB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RUFBRSxDQUFDO1NBQy9CO1FBRUQsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLHFCQUFxQixFQUFFO1lBQ3JDLElBQUksQ0FBQyxPQUFPLENBQUMscUJBQXFCLEVBQUUsQ0FBQztTQUN0QztRQUVELElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyx5QkFBeUIsRUFBRTtZQUN6QyxJQUFJLENBQUMsT0FBTyxDQUFDLHlCQUF5QixFQUFFLENBQUM7U0FDMUM7UUFFRCxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsbUJBQW1CLEVBQUU7WUFDbkMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUM5QjtRQUVELElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRTtZQUNsQyxJQUFJLENBQUMsT0FBTyxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsa0JBQWtCLEtBQUssZUFBZSxDQUFDLENBQUM7U0FDckY7SUFDSCxDQUFDOzhHQWpHVSx3QkFBd0I7a0hBQXhCLHdCQUF3QixjQUh2QixNQUFNLGNBQ04sdUJBQXVCOzsyRkFFeEIsd0JBQXdCO2tCQUpwQyxVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO29CQUNsQixVQUFVLEVBQUUsdUJBQXVCO2lCQUNwQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzUGxhdGZvcm1Ccm93c2VyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IGluamVjdCwgSW5qZWN0YWJsZSwgUExBVEZPUk1fSUQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGluaXRpYWxpemVNYXRvbW9Ib2xkZXIgfSBmcm9tICcuLi9ob2xkZXInO1xuaW1wb3J0IHsgcnVuT25jZSB9IGZyb20gJy4uL3V0aWxzL2Z1bmN0aW9uJztcbmltcG9ydCB7IFNjcmlwdEluamVjdG9yIH0gZnJvbSAnLi4vdXRpbHMvc2NyaXB0LWluamVjdG9yJztcbmltcG9ydCB7IFB1YmxpY0ludGVyZmFjZSB9IGZyb20gJy4uL3V0aWxzL3R5cGVzJztcbmltcG9ydCB7IGFwcGVuZFRyYWlsaW5nU2xhc2ggfSBmcm9tICcuLi91dGlscy91cmwnO1xuaW1wb3J0IHtcbiAgQXV0b01hdG9tb0NvbmZpZ3VyYXRpb24sXG4gIERFRkVSUkVEX0lOVEVSTkFMX01BVE9NT19DT05GSUdVUkFUSU9OLFxuICBnZXRUcmFja2Vyc0NvbmZpZ3VyYXRpb24sXG4gIElOVEVSTkFMX01BVE9NT19DT05GSUdVUkFUSU9OLFxuICBpc0F1dG9Db25maWd1cmF0aW9uTW9kZSxcbiAgaXNFbWJlZGRlZFRyYWNrZXJDb25maWd1cmF0aW9uLFxuICBpc0V4cGxpY2l0VHJhY2tlckNvbmZpZ3VyYXRpb24sXG4gIE1hdG9tb1RyYWNrZXJDb25maWd1cmF0aW9uLFxufSBmcm9tICcuL2NvbmZpZ3VyYXRpb24nO1xuaW1wb3J0IHsgQUxSRUFEWV9JTklUSUFMSVpFRF9FUlJPUiwgQUxSRUFEWV9JTkpFQ1RFRF9FUlJPUiB9IGZyb20gJy4vZXJyb3JzJztcbmltcG9ydCB7IE1hdG9tb1RyYWNrZXIgfSBmcm9tICcuL21hdG9tby10cmFja2VyLnNlcnZpY2UnO1xuXG5mdW5jdGlvbiBjb2VyY2VTaXRlSWQoc2l0ZUlkOiBudW1iZXIgfCBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gYCR7c2l0ZUlkfWA7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkVHJhY2tlclVybCh1cmw6IHN0cmluZywgc3VmZml4OiBzdHJpbmcgfCB1bmRlZmluZWQpOiBzdHJpbmcge1xuICBpZiAoc3VmZml4ID09IG51bGwpIHtcbiAgICByZXR1cm4gYXBwZW5kVHJhaWxpbmdTbGFzaCh1cmwpICsgREVGQVVMVF9UUkFDS0VSX1NVRkZJWDtcbiAgfVxuICByZXR1cm4gdXJsICsgc3VmZml4O1xufVxuXG5jb25zdCBERUZBVUxUX1RSQUNLRVJfU1VGRklYID0gJ21hdG9tby5waHAnO1xuY29uc3QgREVGQVVMVF9TQ1JJUFRfU1VGRklYID0gJ21hdG9tby5qcyc7XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVNYXRvbW9Jbml0aWFsaXplcigpOiBQdWJsaWNJbnRlcmZhY2U8TWF0b21vSW5pdGlhbGl6ZXJTZXJ2aWNlPiB7XG4gIGNvbnN0IGRpc2FibGVkID0gaW5qZWN0KElOVEVSTkFMX01BVE9NT19DT05GSUdVUkFUSU9OKS5kaXNhYmxlZDtcbiAgY29uc3QgaXNCcm93c2VyID0gaXNQbGF0Zm9ybUJyb3dzZXIoaW5qZWN0KFBMQVRGT1JNX0lEKSk7XG5cbiAgcmV0dXJuIGRpc2FibGVkIHx8ICFpc0Jyb3dzZXIgPyBuZXcgTm9vcE1hdG9tb0luaXRpYWxpemVyKCkgOiBuZXcgTWF0b21vSW5pdGlhbGl6ZXJTZXJ2aWNlKCk7XG59XG5cbmV4cG9ydCBjbGFzcyBOb29wTWF0b21vSW5pdGlhbGl6ZXIgaW1wbGVtZW50cyBQdWJsaWNJbnRlcmZhY2U8TWF0b21vSW5pdGlhbGl6ZXJTZXJ2aWNlPiB7XG4gIGluaXRpYWxpemUoKTogdm9pZCB7XG4gICAgLy8gTm8tb3BcbiAgfVxuXG4gIGluaXQoKTogdm9pZCB7XG4gICAgLy8gTm8tb3BcbiAgfVxuXG4gIGluaXRpYWxpemVUcmFja2VyKF86IEF1dG9NYXRvbW9Db25maWd1cmF0aW9uPCdkZWZlcnJlZCc+KTogdm9pZCB7XG4gICAgLy8gTm8tb3BcbiAgfVxufVxuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290JyxcbiAgdXNlRmFjdG9yeTogY3JlYXRlTWF0b21vSW5pdGlhbGl6ZXIsXG59KVxuZXhwb3J0IGNsYXNzIE1hdG9tb0luaXRpYWxpemVyU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgY29uZmlnID0gaW5qZWN0KElOVEVSTkFMX01BVE9NT19DT05GSUdVUkFUSU9OKTtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZlcnJlZENvbmZpZyA9IGluamVjdChERUZFUlJFRF9JTlRFUk5BTF9NQVRPTU9fQ09ORklHVVJBVElPTik7XG4gIHByaXZhdGUgcmVhZG9ubHkgdHJhY2tlciA9IGluamVjdChNYXRvbW9UcmFja2VyKTtcbiAgcHJpdmF0ZSByZWFkb25seSBzY3JpcHRJbmplY3RvciA9IGluamVjdChTY3JpcHRJbmplY3Rvcik7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgaW5pdGlhbGl6ZU1hdG9tb0hvbGRlcigpO1xuICB9XG5cbiAgLy8gVE9ETyB2NyByZW1vdmVcbiAgLyoqIEBkZXByZWNhdGVkIFdpbGwgYmUgcmVtb3ZlZCBpbiB2NysuIFVzZSB7QGxpbmsgaW5pdGlhbGl6ZSBpbml0aWFsaXplKCl9IGluc3RlYWQuICovXG4gIGluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5pbml0aWFsaXplKCk7XG4gIH1cblxuICByZWFkb25seSBpbml0aWFsaXplID0gcnVuT25jZSgoKSA9PiB7XG4gICAgdGhpcy5ydW5QcmVJbml0VGFza3MoKTtcblxuICAgIGlmIChpc0F1dG9Db25maWd1cmF0aW9uTW9kZSh0aGlzLmNvbmZpZykpIHtcbiAgICAgIHRoaXMuaW5qZWN0TWF0b21vU2NyaXB0KHRoaXMuY29uZmlnKTtcbiAgICB9XG4gIH0sIEFMUkVBRFlfSU5JVElBTElaRURfRVJST1IpO1xuXG4gIGluaXRpYWxpemVUcmFja2VyKGNvbmZpZzogQXV0b01hdG9tb0NvbmZpZ3VyYXRpb248J2RlZmVycmVkJz4pOiB2b2lkIHtcbiAgICB0aGlzLmluamVjdE1hdG9tb1NjcmlwdChjb25maWcpO1xuICB9XG5cbiAgcHJpdmF0ZSByZWFkb25seSBpbmplY3RNYXRvbW9TY3JpcHQgPSBydW5PbmNlKFxuICAgIChjb25maWc6IEF1dG9NYXRvbW9Db25maWd1cmF0aW9uPCdhdXRvJyB8ICdkZWZlcnJlZCc+KTogdm9pZCA9PiB7XG4gICAgICBpZiAoaXNFeHBsaWNpdFRyYWNrZXJDb25maWd1cmF0aW9uKGNvbmZpZykpIHtcbiAgICAgICAgY29uc3QgeyBzY3JpcHRVcmw6IGN1c3RvbVNjcmlwdFVybCB9ID0gY29uZmlnO1xuICAgICAgICBjb25zdCBbbWFpblRyYWNrZXIsIC4uLmFkZGl0aW9uYWxUcmFja2Vyc10gPSBnZXRUcmFja2Vyc0NvbmZpZ3VyYXRpb24oY29uZmlnKTtcbiAgICAgICAgY29uc3Qgc2NyaXB0VXJsID1cbiAgICAgICAgICBjdXN0b21TY3JpcHRVcmwgPz8gYXBwZW5kVHJhaWxpbmdTbGFzaChtYWluVHJhY2tlci50cmFja2VyVXJsKSArIERFRkFVTFRfU0NSSVBUX1NVRkZJWDtcblxuICAgICAgICB0aGlzLnJlZ2lzdGVyTWFpblRyYWNrZXIobWFpblRyYWNrZXIpO1xuICAgICAgICB0aGlzLnJlZ2lzdGVyQWRkaXRpb25hbFRyYWNrZXJzKGFkZGl0aW9uYWxUcmFja2Vycyk7XG4gICAgICAgIHRoaXMuc2NyaXB0SW5qZWN0b3IuaW5qZWN0RE9NU2NyaXB0KHNjcmlwdFVybCk7XG4gICAgICB9IGVsc2UgaWYgKGlzRW1iZWRkZWRUcmFja2VyQ29uZmlndXJhdGlvbihjb25maWcpKSB7XG4gICAgICAgIGNvbnN0IHsgc2NyaXB0VXJsLCB0cmFja2VyczogYWRkaXRpb25hbFRyYWNrZXJzIH0gPSB7XG4gICAgICAgICAgdHJhY2tlcnM6IFtdLFxuICAgICAgICAgIC4uLmNvbmZpZyxcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLnJlZ2lzdGVyQWRkaXRpb25hbFRyYWNrZXJzKGFkZGl0aW9uYWxUcmFja2Vycyk7XG4gICAgICAgIHRoaXMuc2NyaXB0SW5qZWN0b3IuaW5qZWN0RE9NU2NyaXB0KHNjcmlwdFVybCk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuZGVmZXJyZWRDb25maWcubWFya1JlYWR5KGNvbmZpZyk7XG4gICAgfSxcbiAgICBBTFJFQURZX0lOSkVDVEVEX0VSUk9SLFxuICApO1xuXG4gIHByaXZhdGUgcmVnaXN0ZXJNYWluVHJhY2tlcihtYWluVHJhY2tlcjogTWF0b21vVHJhY2tlckNvbmZpZ3VyYXRpb24pOiB2b2lkIHtcbiAgICBjb25zdCBtYWluVHJhY2tlclVybCA9IGJ1aWxkVHJhY2tlclVybChtYWluVHJhY2tlci50cmFja2VyVXJsLCBtYWluVHJhY2tlci50cmFja2VyVXJsU3VmZml4KTtcbiAgICBjb25zdCBtYWluVHJhY2tlclNpdGVJZCA9IGNvZXJjZVNpdGVJZChtYWluVHJhY2tlci5zaXRlSWQpO1xuXG4gICAgdGhpcy50cmFja2VyLnNldFRyYWNrZXJVcmwobWFpblRyYWNrZXJVcmwpO1xuICAgIHRoaXMudHJhY2tlci5zZXRTaXRlSWQobWFpblRyYWNrZXJTaXRlSWQpO1xuICB9XG5cbiAgcHJpdmF0ZSByZWdpc3RlckFkZGl0aW9uYWxUcmFja2VycyhhZGRpdGlvbmFsVHJhY2tlcnM6IE1hdG9tb1RyYWNrZXJDb25maWd1cmF0aW9uW10pOiB2b2lkIHtcbiAgICBhZGRpdGlvbmFsVHJhY2tlcnMuZm9yRWFjaCgoeyB0cmFja2VyVXJsLCBzaXRlSWQsIHRyYWNrZXJVcmxTdWZmaXggfSkgPT4ge1xuICAgICAgY29uc3QgYWRkaXRpb25hbFRyYWNrZXJVcmwgPSBidWlsZFRyYWNrZXJVcmwodHJhY2tlclVybCwgdHJhY2tlclVybFN1ZmZpeCk7XG4gICAgICBjb25zdCBhZGRpdGlvbmFsVHJhY2tlclNpdGVJZCA9IGNvZXJjZVNpdGVJZChzaXRlSWQpO1xuXG4gICAgICB0aGlzLnRyYWNrZXIuYWRkVHJhY2tlcihhZGRpdGlvbmFsVHJhY2tlclVybCwgYWRkaXRpb25hbFRyYWNrZXJTaXRlSWQpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBydW5QcmVJbml0VGFza3MoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuY29uZmlnLmFjY2VwdERvTm90VHJhY2spIHtcbiAgICAgIHRoaXMudHJhY2tlci5zZXREb05vdFRyYWNrKHRydWUpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmNvbmZpZy5yZXF1aXJlQ29uc2VudCA9PT0gJ2Nvb2tpZScpIHtcbiAgICAgIHRoaXMudHJhY2tlci5yZXF1aXJlQ29va2llQ29uc2VudCgpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5jb25maWcucmVxdWlyZUNvbnNlbnQgPT09ICd0cmFja2luZycpIHtcbiAgICAgIHRoaXMudHJhY2tlci5yZXF1aXJlQ29uc2VudCgpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmNvbmZpZy5lbmFibGVKU0Vycm9yVHJhY2tpbmcpIHtcbiAgICAgIHRoaXMudHJhY2tlci5lbmFibGVKU0Vycm9yVHJhY2tpbmcoKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5jb25maWcuZGlzYWJsZUNhbXBhaWduUGFyYW1ldGVycykge1xuICAgICAgdGhpcy50cmFja2VyLmRpc2FibGVDYW1wYWlnblBhcmFtZXRlcnMoKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5jb25maWcudHJhY2tBcHBJbml0aWFsTG9hZCkge1xuICAgICAgdGhpcy50cmFja2VyLnRyYWNrUGFnZVZpZXcoKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5jb25maWcuZW5hYmxlTGlua1RyYWNraW5nKSB7XG4gICAgICB0aGlzLnRyYWNrZXIuZW5hYmxlTGlua1RyYWNraW5nKHRoaXMuY29uZmlnLmVuYWJsZUxpbmtUcmFja2luZyA9PT0gJ2VuYWJsZS1wc2V1ZG8nKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==