import { Component, Inject, Input, LOCALE_ID, Optional, SecurityContext, } from '@angular/core';
import { ASYNC_INTERNAL_MATOMO_CONFIGURATION, getTrackersConfiguration, isAutoConfigurationMode, isExplicitTrackerConfiguration, } from '../tracker/configuration';
import { coerceCssSizeBinding } from '../utils/coercion';
import * as i0 from "@angular/core";
import * as i1 from "@angular/platform-browser";
const DEFAULT_BORDER = '0';
const DEFAULT_WIDTH = '600px';
const DEFAULT_HEIGHT = '200px';
const URL_PATTERN = '{SERVER}/index.php?module=CoreAdminHome&action=optOut&language={LOCALE}&backgroundColor={BG_COLOR}&fontColor={COLOR}&fontSize={FONT_SIZE}&fontFamily={FONT_FAMILY}';
function missingServerUrlError() {
    return new Error(`It is required to set [serverUrl] when Matomo configuration mode is set to 'manual'`);
}
/**
 * Basic opt-out form, based on an iframe auto-generated by Matomo.
 *
 * <b>WARNING:</b> By default, this component assumes the tracker url set in MatomoConfiguration is
 * safe to be used as an iframe `src`. You have to make sure that this url is safe before using this
 * component!
 *
 * Note: This component relies on the matomo-generated opt-out form, which is deprecated
 * since Matomo version 4.12.0. It will be marked as deprecated soon.
 *
 * @see https://developer.matomo.org/changelog#new-privacy-opt-out-options
 */
export class MatomoOptOutFormComponent {
    constructor(sanitizer, config, locale = '') {
        this.sanitizer = sanitizer;
        this.config = config;
        this._defaultServerUrlInitialized = false;
        this._border = DEFAULT_BORDER;
        this._width = DEFAULT_WIDTH;
        this._height = DEFAULT_HEIGHT;
        this._iframeSrc = this.sanitizer.bypassSecurityTrustResourceUrl('');
        /** Font color (note that Matomo currently only supports hexadecimal without leading hash notation) */
        this.color = '';
        /** Background color (note that Matomo currently only supports hexadecimal without leading hash notation) */
        this.backgroundColor = '';
        this.fontSize = '';
        this.fontFamily = '';
        // Set default locale
        this.locale = locale;
    }
    get serverUrl() {
        return this._serverUrlOverride;
    }
    /**
     * Set a custom Matomo server url to be used for iframe generation
     * <br>
     * By default, tracker url is retrieved from MatomoConfiguration.
     * <br>
     * <b>WARNING:</b> This component assumes the url you provide is safe to be used as an iframe
     * `src`. You have to make sure that this url is safe before using this component!
     */
    set serverUrl(value) {
        this._serverUrlOverride = value;
    }
    get iframeSrc() {
        return this._iframeSrc;
    }
    get height() {
        return this._height;
    }
    set height(value) {
        this._height = coerceCssSizeBinding(value);
    }
    get width() {
        return this._width;
    }
    set width(value) {
        this._width = coerceCssSizeBinding(value);
    }
    get border() {
        return this._border;
    }
    set border(value) {
        this._border = coerceCssSizeBinding(value);
    }
    ngOnInit() {
        this.updateUrl();
        this.config.then(config => {
            if (isAutoConfigurationMode(config) && isExplicitTrackerConfiguration(config)) {
                this._defaultServerUrl = getTrackersConfiguration(config)[0].trackerUrl;
            }
            this._defaultServerUrlInitialized = true;
            this.updateUrl();
        });
    }
    ngOnChanges(changes) {
        if ('serverUrl' in changes ||
            'locale' in changes ||
            'color' in changes ||
            'backgroundColor' in changes ||
            'fontSize' in changes ||
            'fontFamily' in changes) {
            this.updateUrl();
        }
    }
    updateUrl() {
        let serverUrl = this._defaultServerUrl;
        if (this._serverUrlOverride) {
            serverUrl = this.sanitizer.sanitize(SecurityContext.RESOURCE_URL, this._serverUrlOverride);
        }
        if (!serverUrl) {
            if (this._defaultServerUrlInitialized) {
                throw missingServerUrlError();
            }
            else {
                return;
            }
        }
        const url = URL_PATTERN.replace('{SERVER}', serverUrl)
            .replace('{LOCALE}', encodeURIComponent(this.locale))
            .replace('{COLOR}', encodeURIComponent(this.color))
            .replace('{BG_COLOR}', encodeURIComponent(this.backgroundColor))
            .replace('{FONT_SIZE}', encodeURIComponent(this.fontSize))
            .replace('{FONT_FAMILY}', encodeURIComponent(this.fontFamily));
        this._iframeSrc = this.sanitizer.bypassSecurityTrustResourceUrl(url);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.2", ngImport: i0, type: MatomoOptOutFormComponent, deps: [{ token: i1.DomSanitizer }, { token: ASYNC_INTERNAL_MATOMO_CONFIGURATION }, { token: LOCALE_ID, optional: true }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "17.3.2", type: MatomoOptOutFormComponent, isStandalone: true, selector: "matomo-opt-out-form", inputs: { locale: "locale", color: "color", backgroundColor: "backgroundColor", fontSize: "fontSize", fontFamily: "fontFamily", serverUrl: "serverUrl", height: "height", width: "width", border: "border" }, usesOnChanges: true, ngImport: i0, template: "<iframe\n  [src]=\"iframeSrc\"\n  [style.border]=\"border\"\n  [style.height]=\"height\"\n  [style.width]=\"width\"\n></iframe>\n" }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.2", ngImport: i0, type: MatomoOptOutFormComponent, decorators: [{
            type: Component,
            args: [{ selector: 'matomo-opt-out-form', standalone: true, template: "<iframe\n  [src]=\"iframeSrc\"\n  [style.border]=\"border\"\n  [style.height]=\"height\"\n  [style.width]=\"width\"\n></iframe>\n" }]
        }], ctorParameters: () => [{ type: i1.DomSanitizer }, { type: Promise, decorators: [{
                    type: Inject,
                    args: [ASYNC_INTERNAL_MATOMO_CONFIGURATION]
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [LOCALE_ID]
                }] }], propDecorators: { locale: [{
                type: Input
            }], color: [{
                type: Input
            }], backgroundColor: [{
                type: Input
            }], fontSize: [{
                type: Input
            }], fontFamily: [{
                type: Input
            }], serverUrl: [{
                type: Input
            }], height: [{
                type: Input
            }], width: [{
                type: Input
            }], border: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0b21vLW9wdC1vdXQtZm9ybS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtbWF0b21vLWNsaWVudC9jb3JlL2RpcmVjdGl2ZXMvbWF0b21vLW9wdC1vdXQtZm9ybS5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtbWF0b21vLWNsaWVudC9jb3JlL2RpcmVjdGl2ZXMvbWF0b21vLW9wdC1vdXQtZm9ybS5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULE1BQU0sRUFDTixLQUFLLEVBQ0wsU0FBUyxFQUdULFFBQVEsRUFDUixlQUFlLEdBRWhCLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFDTCxtQ0FBbUMsRUFDbkMsd0JBQXdCLEVBRXhCLHVCQUF1QixFQUN2Qiw4QkFBOEIsR0FDL0IsTUFBTSwwQkFBMEIsQ0FBQztBQUNsQyxPQUFPLEVBQUUsb0JBQW9CLEVBQWdCLE1BQU0sbUJBQW1CLENBQUM7OztBQUV2RSxNQUFNLGNBQWMsR0FBRyxHQUFHLENBQUM7QUFDM0IsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDO0FBQzlCLE1BQU0sY0FBYyxHQUFHLE9BQU8sQ0FBQztBQUMvQixNQUFNLFdBQVcsR0FDZixvS0FBb0ssQ0FBQztBQUV2SyxTQUFTLHFCQUFxQjtJQUM1QixPQUFPLElBQUksS0FBSyxDQUNkLHFGQUFxRixDQUN0RixDQUFDO0FBQ0osQ0FBQztBQUVEOzs7Ozs7Ozs7OztHQVdHO0FBTUgsTUFBTSxPQUFPLHlCQUF5QjtJQXNCcEMsWUFDbUIsU0FBdUIsRUFFdkIsTUFBNEMsRUFDOUIsU0FBaUIsRUFBRTtRQUhqQyxjQUFTLEdBQVQsU0FBUyxDQUFjO1FBRXZCLFdBQU0sR0FBTixNQUFNLENBQXNDO1FBdkJ2RCxpQ0FBNEIsR0FBRyxLQUFLLENBQUM7UUFDckMsWUFBTyxH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ZW50LFxuICBJbmplY3QsXG4gIElucHV0LFxuICBMT0NBTEVfSUQsXG4gIE9uQ2hhbmdlcyxcbiAgT25Jbml0LFxuICBPcHRpb25hbCxcbiAgU2VjdXJpdHlDb250ZXh0LFxuICBTaW1wbGVDaGFuZ2VzLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERvbVNhbml0aXplciwgU2FmZVJlc291cmNlVXJsIH0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlcic7XG5pbXBvcnQge1xuICBBU1lOQ19JTlRFUk5BTF9NQVRPTU9fQ09ORklHVVJBVElPTixcbiAgZ2V0VHJhY2tlcnNDb25maWd1cmF0aW9uLFxuICBJbnRlcm5hbE1hdG9tb0NvbmZpZ3VyYXRpb24sXG4gIGlzQXV0b0NvbmZpZ3VyYXRpb25Nb2RlLFxuICBpc0V4cGxpY2l0VHJhY2tlckNvbmZpZ3VyYXRpb24sXG59IGZyb20gJy4uL3RyYWNrZXIvY29uZmlndXJhdGlvbic7XG5pbXBvcnQgeyBjb2VyY2VDc3NTaXplQmluZGluZywgQ3NzU2l6ZUlucHV0IH0gZnJvbSAnLi4vdXRpbHMvY29lcmNpb24nO1xuXG5jb25zdCBERUZBVUxUX0JPUkRFUiA9ICcwJztcbmNvbnN0IERFRkFVTFRfV0lEVEggPSAnNjAwcHgnO1xuY29uc3QgREVGQVVMVF9IRUlHSFQgPSAnMjAwcHgnO1xuY29uc3QgVVJMX1BBVFRFUk4gPVxuICAne1NFUlZFUn0vaW5kZXgucGhwP21vZHVsZT1Db3JlQWRtaW5Ib21lJmFjdGlvbj1vcHRPdXQmbGFuZ3VhZ2U9e0xPQ0FMRX0mYmFja2dyb3VuZENvbG9yPXtCR19DT0xPUn0mZm9udENvbG9yPXtDT0xPUn0mZm9udFNpemU9e0ZPTlRfU0laRX0mZm9udEZhbWlseT17Rk9OVF9GQU1JTFl9JztcblxuZnVuY3Rpb24gbWlzc2luZ1NlcnZlclVybEVycm9yKCk6IEVycm9yIHtcbiAgcmV0dXJuIG5ldyBFcnJvcihcbiAgICBgSXQgaXMgcmVxdWlyZWQgdG8gc2V0IFtzZXJ2ZXJVcmxdIHdoZW4gTWF0b21vIGNvbmZpZ3VyYXRpb24gbW9kZSBpcyBzZXQgdG8gJ21hbnVhbCdgLFxuICApO1xufVxuXG4vKipcbiAqIEJhc2ljIG9wdC1vdXQgZm9ybSwgYmFzZWQgb24gYW4gaWZyYW1lIGF1dG8tZ2VuZXJhdGVkIGJ5IE1hdG9tby5cbiAqXG4gKiA8Yj5XQVJOSU5HOjwvYj4gQnkgZGVmYXVsdCwgdGhpcyBjb21wb25lbnQgYXNzdW1lcyB0aGUgdHJhY2tlciB1cmwgc2V0IGluIE1hdG9tb0NvbmZpZ3VyYXRpb24gaXNcbiAqIHNhZmUgdG8gYmUgdXNlZCBhcyBhbiBpZnJhbWUgYHNyY2AuIFlvdSBoYXZlIHRvIG1ha2Ugc3VyZSB0aGF0IHRoaXMgdXJsIGlzIHNhZmUgYmVmb3JlIHVzaW5nIHRoaXNcbiAqIGNvbXBvbmVudCFcbiAqXG4gKiBOb3RlOiBUaGlzIGNvbXBvbmVudCByZWxpZXMgb24gdGhlIG1hdG9tby1nZW5lcmF0ZWQgb3B0LW91dCBmb3JtLCB3aGljaCBpcyBkZXByZWNhdGVkXG4gKiBzaW5jZSBNYXRvbW8gdmVyc2lvbiA0LjEyLjAuIEl0IHdpbGwgYmUgbWFya2VkIGFzIGRlcHJlY2F0ZWQgc29vbi5cbiAqXG4gKiBAc2VlIGh0dHBzOi8vZGV2ZWxvcGVyLm1hdG9tby5vcmcvY2hhbmdlbG9nI25ldy1wcml2YWN5LW9wdC1vdXQtb3B0aW9uc1xuICovXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdtYXRvbW8tb3B0LW91dC1mb3JtJyxcbiAgdGVtcGxhdGVVcmw6ICcuL21hdG9tby1vcHQtb3V0LWZvcm0uY29tcG9uZW50Lmh0bWwnLFxuICBzdGFuZGFsb25lOiB0cnVlLFxufSlcbmV4cG9ydCBjbGFzcyBNYXRvbW9PcHRPdXRGb3JtQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMge1xuICBwcml2YXRlIF9kZWZhdWx0U2VydmVyVXJsPzogc3RyaW5nO1xuICBwcml2YXRlIF9kZWZhdWx0U2VydmVyVXJsSW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBfYm9yZGVyOiBzdHJpbmcgPSBERUZBVUxUX0JPUkRFUjtcbiAgcHJpdmF0ZSBfd2lkdGg6IHN0cmluZyA9IERFRkFVTFRfV0lEVEg7XG4gIHByaXZhdGUgX2hlaWdodDogc3RyaW5nID0gREVGQVVMVF9IRUlHSFQ7XG4gIHByaXZhdGUgX2lmcmFtZVNyYzogU2FmZVJlc291cmNlVXJsID0gdGhpcy5zYW5pdGl6ZXIuYnlwYXNzU2VjdXJpdHlUcnVzdFJlc291cmNlVXJsKCcnKTtcbiAgcHJpdmF0ZSBfc2VydmVyVXJsT3ZlcnJpZGU/OiBTYWZlUmVzb3VyY2VVcmw7XG5cbiAgLyoqXG4gICAqIFNldCBhIGN1c3RvbSBsb2NhbGUgZm9yIHRoZSBvcHQtb3V0IGZvcm1cbiAgICogPGJyPlxuICAgKiBEZWZhdWx0IGlzIHRoZSBjdXJyZW50IGFwcCBsb2NhbGUgYXZhaWxhYmxlIGluIExPQ0FMRV9JRCB0b2tlblxuICAgKi9cbiAgQElucHV0KCkgbG9jYWxlOiBzdHJpbmc7XG4gIC8qKiBGb250IGNvbG9yIChub3RlIHRoYXQgTWF0b21vIGN1cnJlbnRseSBvbmx5IHN1cHBvcnRzIGhleGFkZWNpbWFsIHdpdGhvdXQgbGVhZGluZyBoYXNoIG5vdGF0aW9uKSAqL1xuICBASW5wdXQoKSBjb2xvcjogc3RyaW5nID0gJyc7XG4gIC8qKiBCYWNrZ3JvdW5kIGNvbG9yIChub3RlIHRoYXQgTWF0b21vIGN1cnJlbnRseSBvbmx5IHN1cHBvcnRzIGhleGFkZWNpbWFsIHdpdGhvdXQgbGVhZGluZyBoYXNoIG5vdGF0aW9uKSAqL1xuICBASW5wdXQoKSBiYWNrZ3JvdW5kQ29sb3I6IHN0cmluZyA9ICcnO1xuICBASW5wdXQoKSBmb250U2l6ZTogc3RyaW5nID0gJyc7XG4gIEBJbnB1dCgpIGZvbnRGYW1pbHk6IHN0cmluZyA9ICcnO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgc2FuaXRpemVyOiBEb21TYW5pdGl6ZXIsXG4gICAgQEluamVjdChBU1lOQ19JTlRFUk5BTF9NQVRPTU9fQ09ORklHVVJBVElPTilcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZzogUHJvbWlzZTxJbnRlcm5hbE1hdG9tb0NvbmZpZ3VyYXRpb24+LFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoTE9DQUxFX0lEKSBsb2NhbGU6IHN0cmluZyA9ICcnLFxuICApIHtcbiAgICAvLyBTZXQgZGVmYXVsdCBsb2NhbGVcbiAgICB0aGlzLmxvY2FsZSA9IGxvY2FsZTtcbiAgfVxuXG4gIGdldCBzZXJ2ZXJVcmwoKTogU2FmZVJlc291cmNlVXJsIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5fc2VydmVyVXJsT3ZlcnJpZGU7XG4gIH1cblxuICAvKipcbiAgICogU2V0IGEgY3VzdG9tIE1hdG9tbyBzZXJ2ZXIgdXJsIHRvIGJlIHVzZWQgZm9yIGlmcmFtZSBnZW5lcmF0aW9uXG4gICAqIDxicj5cbiAgICogQnkgZGVmYXVsdCwgdHJhY2tlciB1cmwgaXMgcmV0cmlldmVkIGZyb20gTWF0b21vQ29uZmlndXJhdGlvbi5cbiAgICogPGJyPlxuICAgKiA8Yj5XQVJOSU5HOjwvYj4gVGhpcyBjb21wb25lbnQgYXNzdW1lcyB0aGUgdXJsIHlvdSBwcm92aWRlIGlzIHNhZmUgdG8gYmUgdXNlZCBhcyBhbiBpZnJhbWVcbiAgICogYHNyY2AuIFlvdSBoYXZlIHRvIG1ha2Ugc3VyZSB0aGF0IHRoaXMgdXJsIGlzIHNhZmUgYmVmb3JlIHVzaW5nIHRoaXMgY29tcG9uZW50IVxuICAgKi9cbiAgQElucHV0KClcbiAgc2V0IHNlcnZlclVybCh2YWx1ZTogU2FmZVJlc291cmNlVXJsIHwgdW5kZWZpbmVkKSB7XG4gICAgdGhpcy5fc2VydmVyVXJsT3ZlcnJpZGUgPSB2YWx1ZTtcbiAgfVxuXG4gIGdldCBpZnJhbWVTcmMoKTogU2FmZVJlc291cmNlVXJsIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5faWZyYW1lU3JjO1xuICB9XG5cbiAgZ2V0IGhlaWdodCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLl9oZWlnaHQ7XG4gIH1cblxuICBASW5wdXQoKVxuICBzZXQgaGVpZ2h0KHZhbHVlOiBzdHJpbmcpIHtcbiAgICB0aGlzLl9oZWlnaHQgPSBjb2VyY2VDc3NTaXplQmluZGluZyh2YWx1ZSk7XG4gIH1cblxuICBnZXQgd2lkdGgoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5fd2lkdGg7XG4gIH1cblxuICBASW5wdXQoKVxuICBzZXQgd2lkdGgodmFsdWU6IHN0cmluZykge1xuICAgIHRoaXMuX3dpZHRoID0gY29lcmNlQ3NzU2l6ZUJpbmRpbmcodmFsdWUpO1xuICB9XG5cbiAgZ2V0IGJvcmRlcigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLl9ib3JkZXI7XG4gIH1cblxuICBASW5wdXQoKVxuICBzZXQgYm9yZGVyKHZhbHVlOiBzdHJpbmcpIHtcbiAgICB0aGlzLl9ib3JkZXIgPSBjb2VyY2VDc3NTaXplQmluZGluZyh2YWx1ZSk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLnVwZGF0ZVVybCgpO1xuXG4gICAgdGhpcy5jb25maWcudGhlbihjb25maWcgPT4ge1xuICAgICAgaWYgKGlzQXV0b0NvbmZpZ3VyYXRpb25Nb2RlKGNvbmZpZykgJiYgaXNFeHBsaWNpdFRyYWNrZXJDb25maWd1cmF0aW9uKGNvbmZpZykpIHtcbiAgICAgICAgdGhpcy5fZGVmYXVsdFNlcnZlclVybCA9IGdldFRyYWNrZXJzQ29uZmlndXJhdGlvbihjb25maWcpWzBdLnRyYWNrZXJVcmw7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuX2RlZmF1bHRTZXJ2ZXJVcmxJbml0aWFsaXplZCA9IHRydWU7XG4gICAgICB0aGlzLnVwZGF0ZVVybCgpO1xuICAgIH0pO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xuICAgIGlmIChcbiAgICAgICdzZXJ2ZXJVcmwnIGluIGNoYW5nZXMgfHxcbiAgICAgICdsb2NhbGUnIGluIGNoYW5nZXMgfHxcbiAgICAgICdjb2xvcicgaW4gY2hhbmdlcyB8fFxuICAgICAgJ2JhY2tncm91bmRDb2xvcicgaW4gY2hhbmdlcyB8fFxuICAgICAgJ2ZvbnRTaXplJyBpbiBjaGFuZ2VzIHx8XG4gICAgICAnZm9udEZhbWlseScgaW4gY2hhbmdlc1xuICAgICkge1xuICAgICAgdGhpcy51cGRhdGVVcmwoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVVybCgpOiB2b2lkIHtcbiAgICBsZXQgc2VydmVyVXJsOiBzdHJpbmcgfCBudWxsIHwgdW5kZWZpbmVkID0gdGhpcy5fZGVmYXVsdFNlcnZlclVybDtcblxuICAgIGlmICh0aGlzLl9zZXJ2ZXJVcmxPdmVycmlkZSkge1xuICAgICAgc2VydmVyVXJsID0gdGhpcy5zYW5pdGl6ZXIuc2FuaXRpemUoU2VjdXJpdHlDb250ZXh0LlJFU09VUkNFX1VSTCwgdGhpcy5fc2VydmVyVXJsT3ZlcnJpZGUpO1xuICAgIH1cblxuICAgIGlmICghc2VydmVyVXJsKSB7XG4gICAgICBpZiAodGhpcy5fZGVmYXVsdFNlcnZlclVybEluaXRpYWxpemVkKSB7XG4gICAgICAgIHRocm93IG1pc3NpbmdTZXJ2ZXJVcmxFcnJvcigpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHVybCA9IFVSTF9QQVRURVJOLnJlcGxhY2UoJ3tTRVJWRVJ9Jywgc2VydmVyVXJsKVxuICAgICAgLnJlcGxhY2UoJ3tMT0NBTEV9JywgZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMubG9jYWxlKSlcbiAgICAgIC5yZXBsYWNlKCd7Q09MT1J9JywgZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMuY29sb3IpKVxuICAgICAgLnJlcGxhY2UoJ3tCR19DT0xPUn0nLCBlbmNvZGVVUklDb21wb25lbnQodGhpcy5iYWNrZ3JvdW5kQ29sb3IpKVxuICAgICAgLnJlcGxhY2UoJ3tGT05UX1NJWkV9JywgZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMuZm9udFNpemUpKVxuICAgICAgLnJlcGxhY2UoJ3tGT05UX0ZBTUlMWX0nLCBlbmNvZGVVUklDb21wb25lbnQodGhpcy5mb250RmFtaWx5KSk7XG5cbiAgICB0aGlzLl9pZnJhbWVTcmMgPSB0aGlzLnNhbml0aXplci5ieXBhc3NTZWN1cml0eVRydXN0UmVzb3VyY2VVcmwodXJsKTtcbiAgfVxuXG4gIHN0YXRpYyBuZ0FjY2VwdElucHV0VHlwZV9ib3JkZXI6IENzc1NpemVJbnB1dDtcbiAgc3RhdGljIG5nQWNjZXB0SW5wdXRUeXBlX3dpZHRoOiBDc3NTaXplSW5wdXQ7XG4gIHN0YXRpYyBuZ0FjY2VwdElucHV0VHlwZV9oZWlnaHQ6IENzc1NpemVJbnB1dDtcbn1cbiIsIjxpZnJhbWVcbiAgW3NyY109XCJpZnJhbWVTcmNcIlxuICBbc3R5bGUuYm9yZGVyXT1cImJvcmRlclwiXG4gIFtzdHlsZS5oZWlnaHRdPVwiaGVpZ2h0XCJcbiAgW3N0eWxlLndpZHRoXT1cIndpZHRoXCJcbj48L2lmcmFtZT5cbiJdfQ==